<div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <%= link_to root_path, class: "text-gray-500 hover:text-gray-700" do %>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <% end %>
            </li>
            <li>
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </li>
            <li>
                <%= link_to admin_dashboard_path, class: "text-gray-500 hover:text-gray-700" do %>
                Admin
                <% end %>
            </li>
            <li>
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </li>
            <li class="text-gray-900 font-medium">
                Dashboard
            </li>
        </ol>
    </nav>
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-6 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
            <p class="text-gray-600 mt-2">Operations overview • No payments collected on-platform</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <%= link_to 'Users', admin_users_path, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium w-full sm:w-auto text-center" %>
            <%= link_to 'Products', admin_products_path, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium w-full sm:w-auto text-center" %>
            <%= link_to 'Quotation Requests', admin_quotation_requests_path, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium w-full sm:w-auto text-center" %>
            <%= link_to 'Reviews', admin_reviews_path, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium w-full sm:w-auto text-center" %>
            <%= link_to 'Support', support_dashboard_path, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium w-full sm:w-auto text-center" %>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-sm font-semibold text-gray-500">Total Users</h3>
            <p class="text-3xl font-bold text-gray-900"><%= @users_count %></p>
            <p class="text-xs text-gray-500 mt-1"><%= @buyers_count %> buyers • <%= @suppliers_count %> suppliers</p>
            <p class="text-xs text-gray-500 mt-1">Buyer/Supplier ratio: <%= @buyer_supplier_ratio %></p>
            <p class="text-xs text-gray-500 mt-1">Last 7 days: <%= @users_last_7d %> (<%= @users_delta >= 0 ? '+' : '' %><%= @users_delta %> vs prior)</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-sm font-semibold text-gray-500">Products</h3>
            <p class="text-3xl font-bold text-gray-900"><%= @products_count %></p>
            <p class="text-xs text-gray-500 mt-1"><%= @in_stock_count %> in stock • <%= @out_of_stock_count %> out</p>
            <p class="text-xs text-gray-500 mt-1">In-stock rate: <%= @in_stock_rate %>%</p>
            <p class="text-xs text-gray-500 mt-1">Last 7 days: <%= @products_last_7d %> (<%= @products_delta >= 0 ? '+' : '' %><%= @products_delta %> vs prior)</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-sm font-semibold text-gray-500">Quotation Requests</h3>
            <p class="text-3xl font-bold text-gray-900"><%= @quotation_requests_count %></p>
            <p class="text-xs text-gray-500 mt-1">Requests recorded (no payments)</p>
            <p class="text-xs text-gray-500 mt-1">Last 7 days: <%= @quotation_last_7d %> (<%= @quotation_delta >= 0 ? '+' : '' %><%= @quotation_delta %> vs prior)</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-sm font-semibold text-gray-500">Verification Rate</h3>
            <div class="flex items-center gap-2">
                <p class="text-3xl font-bold text-gray-900"><%= @verification_rate %>%</p>
                <span class="text-xs font-semibold px-2 py-1 rounded-full <%= @verification_status == 'good' ? 'bg-green-100 text-green-700' : @verification_status == 'warn' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700' %>">
                    <%= @verification_status == 'good' ? 'Healthy' : @verification_status == 'warn' ? 'Watch' : 'Low' %>
                </span>
            </div>
            <p class="text-xs text-gray-500 mt-1"><%= @unverified_users %> unverified</p>
        </div>
    </div>

        <!-- Charts -->
                        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-sm xl:col-span-2">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">User Signups (30 days)</h2>
                <span class="text-xs text-gray-500">Hover for details</span>
            </div>
            <div class="relative h-56 sm:h-64 lg:h-72">
                <canvas id="signupsChart" class="w-full h-full"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-2">Breakdown by buyer, supplier, admin, and other roles.</p>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Product Categories (30 days)</h2>
                <span class="text-xs text-gray-500">Hover for details</span>
            </div>
            <div class="relative h-56 sm:h-64 lg:h-72">
                <canvas id="categoriesChart" class="w-full h-full"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-2">Top categories over time.</p>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-sm xl:col-span-2">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Most Visited Pages (30 days)</h2>
                <span class="text-xs text-gray-500">Hover for details</span>
            </div>
            <div class="relative h-56 sm:h-64 lg:h-72">
                <canvas id="pageViewsChart" class="w-full h-full"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-2">Top paths by daily views.</p>
        </div>
    </div>

    <!-- Operations Panel -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-5">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Support & Reviews</h2>
                    <p class="text-xs text-gray-500 mt-1">Live operational signals</p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="p-4 rounded-lg bg-blue-50 border border-blue-100">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-semibold text-blue-700 uppercase">Support</span>
                        <span class="text-[11px] text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full">Inbox</span>
                    </div>
                    <p class="text-3xl font-semibold text-blue-900 mt-2"><%= @support_messages_count %></p>
                    <p class="text-xs text-blue-700 mt-1">Unread messages</p>
                </div>
                <div class="p-4 rounded-lg bg-green-50 border border-green-100">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-semibold text-green-700 uppercase">Reviews</span>
                        <span class="text-[11px] text-green-700 bg-green-100 px-2 py-0.5 rounded-full">New</span>
                    </div>
                    <p class="text-3xl font-semibold text-green-900 mt-2"><%= @reviews_count %></p>
                    <p class="text-xs text-green-700 mt-1">Total reviews</p>
                </div>
                <div class="p-4 rounded-lg bg-red-50 border border-red-100">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-semibold text-red-700 uppercase">Flagged</span>
                        <span class="text-[11px] text-red-700 bg-red-100 px-2 py-0.5 rounded-full"><%= @flagged_reviews > 0 ? 'Needs review' : 'Clear' %></span>
                    </div>
                    <p class="text-3xl font-semibold text-red-900 mt-2"><%= @flagged_reviews %></p>
                    <p class="text-xs text-red-700 mt-1">Flagged reviews</p>
                </div>
                <div class="p-4 rounded-lg bg-amber-50 border border-amber-100">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-semibold text-amber-700 uppercase">Verifications</span>
                        <span class="text-[11px] text-amber-700 bg-amber-100 px-2 py-0.5 rounded-full"><%= @pending_verifications > 0 ? 'Pending' : 'Clear' %></span>
                    </div>
                    <p class="text-3xl font-semibold text-amber-900 mt-2"><%= @pending_verifications %></p>
                    <p class="text-xs text-amber-700 mt-1">Awaiting approval</p>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-5">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Activity Feed</h2>
                    <p class="text-xs text-gray-500 mt-1">Latest requests and product adds</p>
                </div>
            </div>
            <% activity_items = [] %>
            <% @recent_quotation_requests.each do |request| %>
                <% activity_items << {
                  type: "Request",
                  title: "Request ##{request.id}",
                  user: request.user.name,
                  time: request.created_at,
                  meta: "via #{request.requested_via.to_s.titleize}",
                  badge: "bg-indigo-100 text-indigo-700"
                } %>
            <% end %>
            <% @recent_products.each do |product| %>
                <% activity_items << {
                  type: "Product",
                  title: product.name,
                  user: product.user.name,
                  time: product.created_at,
                  meta: "New product",
                  badge: "bg-emerald-100 text-emerald-700"
                } %>
            <% end %>
            <% activity_items = activity_items.sort_by { |item| item[:time] }.reverse %>

            <% if activity_items.any? %>
                <div class="space-y-4">
                    <% activity_items.each do |item| %>
                        <div class="flex items-start justify-between gap-4 border-b border-gray-100 pb-4 last:border-b-0">
                            <div>
                                <span class="text-[11px] font-semibold uppercase px-2 py-1 rounded-full <%= item[:badge] %>"><%= item[:type] %></span>
                                <p class="font-medium text-gray-900 mt-2"><%= item[:title] %></p>
                                <p class="text-sm text-gray-600">By <%= item[:user] %></p>
                                <p class="text-xs text-gray-500 mt-1"><%= item[:meta] %></p>
                            </div>
                            <div class="text-right whitespace-nowrap">
                                <p class="text-xs text-gray-500"><%= item[:time].strftime('%d %b %Y') %></p>
                                <p class="text-xs text-gray-400"><%= item[:time].strftime('%H:%M') %></p>
                            </div>
                        </div>
                    <% end %>
                </div>
            <% else %>
                <p class="text-gray-500">No recent activity</p>
            <% end %>
        </div>
    </div>

    <script type="application/json" id="signupsChartData">
        <%= raw({ labels: @signup_labels, series: @signup_series_by_role }.to_json) %>
    </script>
    <script type="application/json" id="categoriesChartData">
        <%= raw({ labels: @category_labels, series: @category_series }.to_json) %>
    </script>
    <script type="application/json" id="pageViewsChartData">
        <%= raw({ labels: @pageview_labels, series: @pageview_series }.to_json) %>
    </script>
    <script type="module">
        (function() {
            let signupsChartInstance = null;
            let categoriesChartInstance = null;
            let pageViewsChartInstance = null;
            let chartModule = null;

            const renderSignupsChart = () => {
                const dataEl = document.getElementById("signupsChartData");
                const canvas = document.getElementById("signupsChart");
                if (!dataEl || !canvas || !chartModule) return;

                let payload;
                try {
                    payload = JSON.parse(dataEl.textContent);
                } catch (error) {
                    return;
                }

                const labels = payload.labels || [];
                const series = payload.series || {};
                const palette = {
                    buyer: "#16a34a",
                    supplier: "#2563eb",
                    admin: "#f59e0b",
                    other: "#6b7280"
                };

                const datasets = Object.entries(series).map(([role, values]) => {
                    const key = role.toLowerCase();
                    return {
                        label: role,
                        data: values,
                        borderColor: palette[key] || "#10b981",
                        backgroundColor: (palette[key] || "#10b981") + "33",
                        tension: 0.3,
                        fill: true
                    };
                });

                if (signupsChartInstance) {
                    signupsChartInstance.destroy();
                }

                signupsChartInstance = new chartModule(canvas, {
                    type: "line",
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: "index", intersect: false },
                        plugins: {
                            tooltip: { mode: "index", intersect: false },
                            legend: { position: "bottom" }
                        },
                        scales: {
                            x: { title: { display: true, text: "Date" }, ticks: { maxTicksLimit: 8 } },
                            y: { title: { display: true, text: "Signups" }, beginAtZero: true, ticks: { precision: 0 } }
                        }
                    }
                });
            };

            const renderCategoriesChart = () => {
                const dataEl = document.getElementById("categoriesChartData");
                const canvas = document.getElementById("categoriesChart");
                if (!dataEl || !canvas || !chartModule) return;

                let payload;
                try {
                    payload = JSON.parse(dataEl.textContent);
                } catch (error) {
                    return;
                }

                const labels = payload.labels || [];
                const series = payload.series || {};
                const palette = ["#16a34a", "#22c55e", "#f59e0b", "#3b82f6", "#a855f7"];
                const datasets = Object.entries(series).map(([category, values], index) => ({
                    label: category,
                    data: values,
                    borderColor: palette[index % palette.length],
                    backgroundColor: palette[index % palette.length] + "33",
                    tension: 0.3,
                    fill: true
                }));

                if (categoriesChartInstance) {
                    categoriesChartInstance.destroy();
                }

                categoriesChartInstance = new chartModule(canvas, {
                    type: "line",
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: "index", intersect: false },
                        plugins: {
                            tooltip: { mode: "index", intersect: false },
                            legend: { position: "bottom" }
                        },
                        scales: {
                            x: { title: { display: true, text: "Date" }, ticks: { maxTicksLimit: 8 } },
                            y: { title: { display: true, text: "Products" }, beginAtZero: true, ticks: { precision: 0 } }
                        }
                    }
                });
            };

            const renderPageViewsChart = () => {
                const dataEl = document.getElementById("pageViewsChartData");
                const canvas = document.getElementById("pageViewsChart");
                if (!dataEl || !canvas || !chartModule) return;

                let payload;
                try {
                    payload = JSON.parse(dataEl.textContent);
                } catch (error) {
                    return;
                }

                const labels = payload.labels || [];
                const series = payload.series || {};
                const palette = ["#2563eb", "#16a34a", "#f59e0b", "#7c3aed", "#ef4444"];
                const datasets = Object.entries(series).map(([path, values], index) => ({
                    label: path,
                    data: values,
                    borderColor: palette[index % palette.length],
                    backgroundColor: palette[index % palette.length] + "33",
                    tension: 0.3,
                    fill: true
                }));

                if (pageViewsChartInstance) {
                    pageViewsChartInstance.destroy();
                }

                pageViewsChartInstance = new chartModule(canvas, {
                    type: "line",
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: "index", intersect: false },
                        plugins: {
                            tooltip: { mode: "index", intersect: false },
                            legend: { position: "bottom" }
                        },
                        scales: {
                            x: { title: { display: true, text: "Date" }, ticks: { maxTicksLimit: 8 } },
                            y: { title: { display: true, text: "Views" }, beginAtZero: true, ticks: { precision: 0 } }
                        }
                    }
                });
            };

            const ensureChartReady = async () => {
                if (!chartModule) {
                    try {
                        const mod = await import("chart.js/auto");
                        chartModule = mod.default || mod.Chart || null;
                    } catch (error) {
                        const fallback = await loadChartFromCdn();
                        if (!fallback) {
                            setStatus("Failed to load Chart.js.");
                            return;
                        }
                        chartModule = fallback;
                    }
                }
                renderSignupsChart();
                renderCategoriesChart();
                renderPageViewsChart();
            };

            const loadChartFromCdn = () => {
                return new Promise((resolve) => {
                    if (window.Chart) {
                        resolve(window.Chart);
                        return;
                    }

                    const existing = document.querySelector("script[data-chartjs-fallback]");
                    if (existing) {
                        existing.addEventListener("load", () => resolve(window.Chart || null));
                        existing.addEventListener("error", () => resolve(null));
                        return;
                    }

                    const script = document.createElement("script");
                    script.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js";
                    script.async = true;
                    script.dataset.chartjsFallback = "true";
                    script.addEventListener("load", () => resolve(window.Chart || null));
                    script.addEventListener("error", () => resolve(null));
                    document.head.appendChild(script);
                });
            };

            document.addEventListener("turbo:load", ensureChartReady);
            document.addEventListener("DOMContentLoaded", ensureChartReady);
            document.addEventListener("turbo:render", ensureChartReady);

            if (document.readyState !== "loading") {
                ensureChartReady();
            }
        })();
    </script>
    </div>