<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <%= link_to root_path, class: "text-gray-500 hover:text-gray-700" do %>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <% end %>
            </li>
            <li>
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </li>
            <li>
                <%= link_to products_path, class: "text-gray-500 hover:text-gray-700" do %>
                Products
                <% end %>
            </li>
            <li>
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </li>
            <li>
                <%= link_to products_path(categories: [@product.category]), class: "text-gray-500 hover:text-gray-700" do %>
                <%= @product.category.humanize %>
                <% end %>
            </li>
            <li>
                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </li>
            <li class="text-gray-900 font-medium">
                <%= @product.name %>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- Product Images -->
        <div class="space-y-4">
            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                <% if @product.primary_image %>
                <%= image_tag @product.primary_image, 
              class: "w-full h-full object-cover",
              id: "main-image" %>
                <% else %>
                <div class="w-full h-full flex items-center justify-center text-6xl">
                    <%= @product.category_icon %>
                </div>
                <% end %>
            </div>

            <% if @product.images.count > 1 %>
            <div class="grid grid-cols-4 gap-2">
                <% @product.images.each_with_index do |image, index| %>
                <%= image_tag image, 
                class: "aspect-square object-cover rounded-md cursor-pointer hover:opacity-80 transition-opacity #{index == 0 ? 'ring-2 ring-green-600' : ''}",
                onclick: "changeMainImage(this, #{index})" %>
                <% end %>
            </div>
            <% end %>
        </div>

        <!-- Product Details -->
        <div class="space-y-6">
            <!-- Header -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <span class="<%= @product.category_color %> px-3 py-1 rounded-full text-sm font-medium">
                        <%= @product.category_icon %> <%= @product.category.humanize %>
                    </span>

                    <% if @product.is_organic %>
                    <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                        Organic
                    </span>
                    <% end %>
                </div>

                <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= @product.name %></h1>

                <div class="flex items-center space-x-4 mb-4">
                    <div class="flex items-center">
                        <% if @product.has_ratings? %>
                        <div class="flex text-yellow-400 mr-2">
                            <% @product.star_rating.times do %>
                            <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <% end %>
                            <% if @product.average_rating % 1 >= 0.5 %>
                            <svg class="w-5 h-5 fill-current opacity-50" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <% end %>
                            <% (5 - @product.star_rating).times do %>
                            <svg class="w-5 h-5 text-gray-300" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <% end %>
                        </div>
                        <span class="text-sm text-gray-600">
                            <%= @product.display_rating %> (<%= @product.reviews_count %> reviews)
                        </span>
                        <% else %>
                        <span class="text-sm text-gray-500">No reviews yet</span>
                        <% end %>
                    </div>

                    <span class="text-sm text-gray-500">•</span>

                    <span class="text-sm text-gray-600">
                        <%= @product.serial_number %>
                    </span>

                    <span class="text-sm text-gray-500">•</span>



                    <div class="text-sm text-gray-600">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <%= @product.location || 'Location not specified' %>
                    </div>
                </div>

                <div class="flex items-baseline space-x-2">
                    <span class="text-3xl font-bold text-gray-900">
                        <%= number_to_currency(@product.price, unit: "£") %>
                    </span>
                    <span class="text-lg text-gray-500">/ <%= @product.unit %></span>
                </div>
            </div>

            <!-- Supplier Info -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <% if @product.user.avatar.attached? %>
                    <%= image_tag @product.user.avatar, class: "h-12 w-12 rounded-full object-cover" %>
                    <% else %>
                    <div class="h-12 w-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <% end %>

                    <div>
                        <h3 class="font-medium text-gray-900">Sold by <%= @product.sold_by %></h3>
                        <p class="text-sm text-gray-600">
                            <% if @product.user.supplier? %>
                            Local Supplier
                            <% else %>
                            Supplier
                            <% end %>
                            <% if @product.user.location.present? %>
                            • <%= @product.user.location %>
                            <% end %>
                        </p>
                    </div>

                    <%= link_to user_path(@product.user), 
              class: "ml-auto text-green-600 hover:text-green-700 text-sm font-medium" do %>
                    View Profile
                    <% end %>
                </div>
            </div>

            <!-- Add to Cart / Quotation Section -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex items-center space-x-4 mb-4">
                    <span class="text-2xl font-bold text-gray-800"><%= number_to_currency(@product.price, unit: "£") %></span>
                    <span class="text-sm text-gray-600">per <%= @product.unit %></span>
                </div>

                <% if @product.in_stock? %>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label for="quantity" class="text-sm font-medium text-gray-700">Quantity:</label>
                        <input type="number" id="quantity" name="quantity" value="1" min="1" max="<%= @product.stock_quantity %>" class="w-20 px-3 py-2 border border-gray-300 rounded-md">
                        <span class="text-sm text-gray-600"><%= @product.unit.pluralize %></span>
                    </div>

                    <%= link_to quotation_product_path(@product, quantity: 1), 
                  class: "w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200 text-center block",
                  data: { turbo: false } do %>
                    Get Quotation
                    <% end %>
                </div>
                <% else %>
                <button disabled class="w-full bg-gray-400 text-white font-medium py-3 px-6 rounded-lg cursor-not-allowed">
                    Out of Stock
                </button>
                <% end %>
            </div>

            <!-- Product Details -->
            <div class="border-t pt-6">
                <h3 class="font-medium text-gray-900 mb-3">Product Details</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Category:</span>
                        <span class="font-medium ml-2"><%= @product.category.humanize %></span>
                    </div>
                    <div>
                        <span class="text-gray-500">Unit:</span>
                        <span class="font-medium ml-2"><%= @product.unit %></span>
                    </div>
                    <% if @product.harvest_date %>
                    <div>
                        <span class="text-gray-500">Harvest Date:</span>
                        <span class="font-medium ml-2"><%= format_date(@product.harvest_date) %></span>
                    </div>
                    <% end %>
                    <% if @product.expiry_date %>
                    <div>
                        <span class="text-gray-500">Best Before:</span>
                        <span class="font-medium ml-2"><%= format_date(@product.expiry_date) %></span>
                    </div>
                    <% end %>
                </div>
            </div>

            <!-- Product Management (for product owner) -->
            <% if current_user&.can_manage_product?(@product) %>
            <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Product Management</h3>
                <div class="flex flex-wrap gap-3">
                    <%= link_to 'Edit Product', edit_product_path(@product), class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium" %>

                    <% if @product.in_stock? %>
                    <%= button_to 'Mark Out of Stock', toggle_availability_product_path(@product), method: :post, class: "bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md text-sm font-medium" %>
                    <% else %>
                    <%= button_to 'Mark In Stock', toggle_availability_product_path(@product), method: :post, class: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium" %>
                    <% end %>

                    <%= button_to 'Delete Product', product_path(@product), method: :delete, 
          data: { confirm: 'Are you sure you want to delete this product?' }, 
          class: "bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium" %>
                </div>
            </div>
            <% end %>
        </div>
    </div>

    <!-- Description -->
    <% if @product.description.present? %>
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Description</h3>
        <p class="text-gray-700 leading-relaxed">
            <%= simple_format(@product.description) %>
        </p>
    </div>
    <% end %>

    <!-- Reviews Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <!-- Reviews Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Customer Reviews</h3>
                <div class="flex items-center space-x-4">
                    <% if @product.has_ratings? %>
                    <div class="flex items-center space-x-2">
                        <div class="flex text-yellow-400">
                            <% 5.times do |i| %>
                            <% if i < @product.star_rating %>
                            <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <% else %>
                            <svg class="w-5 h-5 text-gray-300" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            <% end %>
                            <% end %>
                        </div>
                        <span class="text-lg font-semibold text-gray-900">
                            <%= @product.display_rating %> out of 5
                        </span>
                    </div>
                    <span class="text-gray-600">
                        <%= @product.reviews_count %> <%= 'review'.pluralize(@product.reviews_count) %>
                    </span>
                    <% else %>
                    <span class="text-gray-500 italic">No reviews yet</span>
                    <% end %>
                </div>
            </div>

            <% if @can_review %>
            <button id="write-review-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 shadow-sm hover:shadow-md">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span>Write a Review</span>
                </div>
            </button>
            <% end %>
        </div>

        <!-- Review Form -->
        <% if @can_review %>
        <div id="review-form" class="hidden bg-gray-50 rounded-xl p-6 mb-8 border border-gray-200">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">Write Your Review</h4>
            <%= form_with model: [@product, @review], local: true, class: "space-y-6" do |form| %>
            <!-- Rating Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">Your Rating</label>
                <div class="flex space-x-1" id="rating-stars">
                    <% 5.times do |i| %>
                    <button type="button" class="rating-star text-3xl text-gray-300 hover:text-yellow-400 transition-colors duration-200 focus:outline-none transform hover:scale-110" data-rating="<%= i + 1 %>">
                        ★
                    </button>
                    <% end %>
                </div>
                <%= form.hidden_field :rating, id: "rating-input", value: 0 %>
                <p id="rating-text" class="text-sm text-gray-500 mt-2">Click on a star to rate</p>
            </div>

            <!-- Comment Field -->
            <div>
                <%= form.label :comment, "Your Review", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= form.text_area :comment, 
                      rows: 5,
                      placeholder: "Share your experience with this product... What did you like? What could be improved?",
                      class: "w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors duration-200 resize-none" %>
            </div>

            <!-- Form Actions -->
            <div class="flex space-x-4">
                <%= form.submit "Submit Review", 
                      class: "bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed",
                      id: "submit-review-btn",
                      disabled: true %>
                <button type="button" id="cancel-review-btn" class="bg-white hover:bg-gray-50 text-gray-700 px-6 py-3 rounded-lg font-medium border border-gray-300 transition-colors duration-200 shadow-sm hover:shadow-md">
                    Cancel
                </button>
            </div>
            <% end %>
        </div>
        <% end %>

        <!-- Reviews List -->
        <% if @reviews.any? %>
        <div class="space-y-6">
            <% @reviews.each do |review| %>
            <div class="border-b border-gray-200 pb-6 last:border-b-0 last:pb-0">
                <div class="flex items-start space-x-4">
                    <!-- User Avatar -->
                    <div class="flex-shrink-0">
                        <% if review.user.avatar.attached? %>
                        <%= image_tag review.user.avatar, class: "h-12 w-12 rounded-full object-cover shadow-sm" %>
                        <% else %>
                        <div class="h-12 w-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center shadow-sm">
                            <span class="text-white font-semibold text-sm">
                                <%= initials(review.user.name) %>
                            </span>
                        </div>
                        <% end %>
                    </div>

                    <!-- Review Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="font-semibold text-gray-900"><%= review.user.name %></span>
                            <div class="flex text-yellow-400">
                                <% review.rating.times do %>
                                <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                <% end %>
                                <% (5 - review.rating).times do %>
                                <svg class="w-4 h-4 text-gray-300" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                <% end %>
                            </div>
                            <span class="text-sm text-gray-500">
                                <%= time_ago_in_words(review.created_at) %> ago
                            </span>
                        </div>
                        <p class="text-gray-700 leading-relaxed"><%= review.comment %></p>
                    </div>
                </div>
            </div>
            <% end %>
        </div>

        <!-- Pagination -->
        <% if @reviews.total_pages > 1 %>
        <div class="mt-8 flex justify-center">
            <%= paginate @reviews, 
                  theme: 'tailwind', 
                  class: 'flex space-x-2' %>
        </div>
        <% end %>
        <% else %>
        <!-- Empty State -->
        <div class="text-center py-12">
            <div class="max-w-md mx-auto">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                </div>
                <h4 class="text-lg font-medium text-gray-900 mb-2">No reviews yet</h4>
                <p class="text-gray-500 mb-6">Be the first to share your experience with this product!</p>
                <% unless @can_review %>
                <p class="text-sm text-gray-400">You need to purchase this product to leave a review.</p>
                <% end %>
            </div>
        </div>
        <% end %>
    </div>

    <!-- Related Products -->
    <% if @related_products.any? %>
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-medium text-gray-900 mb-6">Related Products</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <% @related_products.each do |product| %>
            <div class="group">
                <%= link_to product_path(product) do %>
                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden mb-3">
                    <% if product.primary_image %>
                    <%= image_tag product.primary_image, 
                          class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" %>
                    <% else %>
                    <div class="w-full h-full flex items-center justify-center text-3xl">
                        <%= product.category_icon %>
                    </div>
                    <% end %>
                </div>
                <h4 class="font-medium text-gray-900 group-hover:text-green-600 transition-colors">
                    <%= product.name %>
                </h4>
                <p class="text-green-600 font-semibold">
                    <%= number_to_currency(product.price, unit: "£") %> / <%= product.unit %>
                </p>
                <% end %>
            </div>
            <% end %>
        </div>
    </div>
    <% end %>
</div>

<script>
    // Image gallery
    function changeMainImage(clickedImg, index) {
        document.getElementById('main-image').src = clickedImg.src;

        // Update active thumbnail
        document.querySelectorAll('.grid img').forEach((img, i) => {
            img.classList.toggle('ring-2', i === index);
            img.classList.toggle('ring-green-600', i === index);
        });
    }

    // Review form functionality
    document.addEventListener('DOMContentLoaded', function() {
        const writeReviewBtn = document.getElementById('write-review-btn');
        const reviewForm = document.getElementById('review-form');
        const cancelReviewBtn = document.getElementById('cancel-review-btn');
        const ratingStars = document.querySelectorAll('.rating-star');
        const ratingInput = document.getElementById('rating-input');
        const ratingText = document.getElementById('rating-text');
        const submitReviewBtn = document.getElementById('submit-review-btn');

        // Toggle review form
        if (writeReviewBtn && reviewForm) {
            writeReviewBtn.addEventListener('click', () => {
                reviewForm.classList.remove('hidden');
                writeReviewBtn.classList.add('hidden');
            });
        }

        if (cancelReviewBtn && reviewForm) {
            cancelReviewBtn.addEventListener('click', () => {
                reviewForm.classList.add('hidden');
                if (writeReviewBtn) writeReviewBtn.classList.remove('hidden');
                resetRating();
            });
        }

        // Rating stars functionality
        function resetRating() {
            if (ratingStars.length > 0 && ratingInput) {
                ratingInput.value = 0;
                ratingStars.forEach(star => {
                    star.classList.remove('text-yellow-400');
                    star.classList.add('text-gray-300');
                });
                if (ratingText) ratingText.textContent = 'Click on a star to rate';
                if (submitReviewBtn) submitReviewBtn.disabled = true;
            }
        }

        if (ratingStars.length > 0 && ratingInput) {
            ratingStars.forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.rating);
                    ratingInput.value = rating;

                    // Update star colors
                    ratingStars.forEach((s, index) => {
                        if (index < rating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-300');
                        }
                    });

                    // Update rating text
                    if (ratingText) {
                        const ratingTexts = [
                            'Click on a star to rate',
                            'Poor',
                            'Fair',
                            'Good',
                            'Very Good',
                            'Excellent'
                        ];
                        ratingText.textContent = ratingTexts[rating];
                    }

                    // Enable submit button
                    if (submitReviewBtn) {
                        submitReviewBtn.disabled = false;
                    }
                });

                // Add hover effects
                star.addEventListener('mouseenter', () => {
                    const hoverRating = parseInt(star.dataset.rating);
                    ratingStars.forEach((s, index) => {
                        if (index < hoverRating) {
                            s.classList.add('text-yellow-300');
                        }
                    });
                });

                star.addEventListener('mouseleave', () => {
                    const currentRating = parseInt(ratingInput.value);
                    ratingStars.forEach((s, index) => {
                        s.classList.remove('text-yellow-300');
                        if (index >= currentRating) {
                            s.classList.add('text-gray-300');
                        }
                    });
                });
            });
        }
    });
</script>