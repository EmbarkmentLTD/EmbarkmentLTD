<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-semibold">
                <% if params[:search].present? %>
                Search results for "<%= params[:search] %>"
                <% else %>
                All Products
                <% end %>
            </h1>
            <span class="text-gray-500">(<%= @products.total_count %> products)</span>
        </div>

        <!-- Simple Search Bar -->
        <div class="mt-2 md:mt-0">
            <%= form_with url: products_path, method: :get, local: true, class: "flex items-center" do |form| %>
            <div class="relative">
                <%= form.text_field :search, 
                value: params[:search],
                placeholder: "Search products...",
                class: "border border-gray-300 rounded-md pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 w-64" %>
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i data-lucide="search" class="h-4 w-4 text-gray-400"></i>
                </div>
            </div>
            <% end %>
        </div>

        <div class=" flex items-center space-x-2 ">
            <!-- Sort Dropdown -->
            <%= form_with url: products_path, method: :get, local: true, class: "flex items-center space-x-2" do |form| %>
            <%= form.hidden_field :search, value: params[:search] %>
            <%= form.hidden_field :categories, value: params[:categories] %>
            <%= form.hidden_field :organic, value: params[:organic] %>
            <%= form.hidden_field :in_stock, value: params[:in_stock] %>
            <%= form.hidden_field :min_price, value: params[:min_price] %>
            <%= form.hidden_field :max_price, value: params[:max_price] %>
            <%= form.hidden_field :location, value: params[:location] %>

            <%= form.select :sort_by, 
            options_for_select([
              ['Most Popular', ''],
              ['Price: Low to High', 'price_low'],
              ['Price: High to Low', 'price_high'],
              ['Highest Rated', 'rating'],
              ['Newest First', 'newest'],
              ['Name A-Z', 'name']
            ], params[:sort_by]), 
            {},
            { 
              class: "border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-green-500",
              onchange: "this.form.submit();"
            } %>
            <% end %>

            <!-- Mobile Filter Toggle -->
            <button id="mobile-filter-toggle" class="md:hidden bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-md text-sm font-medium transition-colors">
                <i data-lucide="filter" class="h-4 w-4 inline mr-2"></i>
                Filters
            </button>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Filters Sidebar -->
        <div id="filters-sidebar" class="lg:w-64 space-y-6 hidden lg:block">
            <%= form_with url: products_path, method: :get, local: true, class: "space-y-6" do |form| %>
            <%= form.hidden_field :search, value: params[:search] %>
            <%= form.hidden_field :sort_by, value: params[:sort_by] %>

            <!-- Categories -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-medium mb-3">Categories</h3>
                <div class="space-y-2">
                    <% @categories.each do |category| %>
                    <label class="flex items-center">
                        <%= check_box_tag 'categories[]', category[:key], 
                    (params[:categories] && params[:categories].include?(category[:key])),
                    { class: "rounded border-gray-300 text-green-600 focus:ring-green-500" } %>
                        <span class="ml-2 text-sm text-gray-700">
                            <%= category[:icon] %> <%= category[:name] %>
                            <span class="text-gray-400">(<%= category[:count] %>)</span>
                        </span>
                    </label>
                    <% end %>
                </div>
            </div>

            <!-- Price Range -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-medium mb-3">Price Range</h3>
                <div class="flex space-x-2">
                    <%= form.number_field :min_price, 
                placeholder: "¬£#{@min_price.to_i}",
                value: params[:min_price],
                min: @min_price,
                max: @max_price,
                step: 0.01,
                class: "flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-green-500" %>
                    <span class="flex items-center text-gray-500">to</span>
                    <%= form.number_field :max_price, 
                placeholder: "¬£#{@max_price.to_i}",
                value: params[:max_price],
                min: @min_price,
                max: @max_price,
                step: 0.01,
                class: "flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-green-500" %>
                </div>
            </div>

            <!-- Options -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-medium mb-3">Options</h3>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <%= check_box_tag :organic, true, params[:organic] == 'true',
                  { class: "rounded border-gray-300 text-green-600 focus:ring-green-500" } %>
                        <span class="ml-2 text-sm text-gray-700">Organic Only</span>
                    </label>

                    <label class="flex items-center">
                        <%= check_box_tag :in_stock, true, params[:in_stock] == 'true',
                  { class: "rounded border-gray-300 text-green-600 focus:ring-green-500" } %>
                        <span class="ml-2 text-sm text-gray-700">In Stock</span>
                    </label>
                </div>
            </div>

            <!-- Location -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-medium mb-3">Location</h3>
                                <%= form.country_select :location,
                            { include_blank: "All countries", selected: params[:location] },
                            { class: "w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-green-500" } %>
            </div>

            <!-- Rating -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-medium mb-3">Minimum Rating</h3>
                <div class="space-y-2">
                    <% [4, 3, 2, 1].each do |rating| %>
                    <label class="flex items-center">
                        <%= radio_button_tag :min_rating, rating, params[:min_rating] == rating.to_s,
                    { class: "border-gray-300 text-green-600 focus:ring-green-500" } %>
                        <span class="ml-2 text-sm text-gray-700">
                            <%= '‚òÖ' * rating %>
                            <%= '‚òÜ' * (5 - rating) %>
                            & up
                        </span>
                    </label>
                    <% end %>
                </div>
            </div>

            <div class="flex space-x-2">
                <%= form.submit "Apply Filters", 
                class: "flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors" %>
                <%= link_to "Clear", products_path, 
                class: "flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium text-center transition-colors" %>
            </div>
            <% end %>
        </div>


        <!-- Products Grid -->
        <div class="flex-1">
            <% if @products.any? %>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <% @products.each do |product| %>
                <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow overflow-hidden group">
                    <%= link_to product_path(product) do %>
                    <div class="aspect-square relative overflow-hidden">
                        <% if product.primary_image %>
                        <%= image_tag product.primary_image, 
                      class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" %>
                        <% else %>
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                            <span class="text-4xl"><%= product.category_icon %></span>
                        </div>
                        <% end %>

                        <% if product.is_organic %>
                        <div class="absolute top-3 left-3">
                            <span class="bg-green-600 text-white px-2 py-1 rounded-full text-xs font-medium">
                                Organic
                            </span>
                        </div>
                        <% end %>

                        <% unless product.in_stock? %>
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center">
                            <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                                Out of Stock
                            </span>
                        </div>
                        <% end %>
                    </div>

                    <div class="p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="<%= product.category_color %> px-2 py-1 rounded-full text-xs font-medium">
                                <%= product.category.humanize %>
                            </span>
                            <div class="flex items-center text-yellow-400">
                                <% if product.has_ratings? %>
                                <i data-lucide="star" class="h-4 w-4 fill-current"></i>
                                <span class="text-sm text-gray-600 ml-1"><%= product.display_rating %></span>
                                <% end %>
                            </div>
                        </div>

                        <h3 class="font-semibold text-gray-900 mb-2 group-hover:text-green-600 transition-colors">
                            <%= product.name %>
                        </h3>

                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                            <%= truncate(product.description, length: 60) %>
                        </p>

                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <span class="text-lg font-bold text-gray-900">
                                    ¬£<%= product.price %>
                                </span>
                                <span class="text-sm text-gray-500">/ <%= product.unit %></span>
                            </div>

                            <div class="text-sm text-gray-500">
                                by <%= product.sold_by %>
                            </div>
                        </div>

                        <!-- GET QUOTATION BUTTON -->
                        <% if product.in_stock? %>
                        <div class="mt-2">
                                <%= link_to quotation_cart_path(product_id: product.id, quantity: 1), 
                      class: "w-full bg-green-600 hover:bg-green-700 text-white text-center py-2 px-4 rounded-md font-medium transition-colors block",
                      data: { turbo: false } do %>
                            <div class="flex items-center justify-center space-x-2">
                                <i data-lucide="file-text" class="h-4 w-4"></i>
                                <span>Get Quotation</span>
                            </div>
                            <% end %>
                        </div>
                        <% else %>
                        <div class="mt-2">
                            <button disabled class="w-full bg-gray-400 text-white text-center py-2 px-4 rounded-md font-medium cursor-not-allowed">
                                Out of Stock
                            </button>
                        </div>
                        <% end %>
                    </div>
                    <% end %>
                </div>
                <% end %>
            </div>
            <!-- Pagination -->
            <div class="mt-8 flex justify-center">
                <%= paginate @products %>
            </div>
            <% else %>
            <div class="text-center py-12">
                <div class="text-6xl mb-4">üîç</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
                <p class="text-gray-500 mb-4">Try adjusting your search criteria or browse all products.</p>
                <%= link_to "Clear Filters", products_path, 
                class: "bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-medium transition-colors" %>
            </div>
            <% end %>
        </div>
    </div>
</div>


<script>
    // Mobile filter toggle
    document.getElementById('mobile-filter-toggle')?.addEventListener('click', function() {
        const sidebar = document.getElementById('filters-sidebar');
        sidebar.classList.toggle('hidden');
    });
</script>