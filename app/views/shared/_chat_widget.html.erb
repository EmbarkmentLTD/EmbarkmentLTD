<!-- Add this RIGHT HERE at the beginning - BEFORE your existing chat widget -->
<% if user_signed_in? %>
<% if current_user.email_verified? || current_user.admin? || current_user.support? %>
<!-- Show full chat widget (your existing code goes here) -->

<!--------------------------------- Draggable Floating Quick Chat Widget ------------------->
<div id="chat-widget" class="fixed bottom-6 right-6 z-50 cursor-move" style="touch-action: none;">
    <!-- Chat Toggle Button -->
    <button id="chat-toggle" class="bg-green-600 hover:bg-green-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 drag-handle relative">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <!-- Single badge element - always present but hidden when count is 0 -->
        <% if user_signed_in? %>
        <span id="chat-toggle-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center shadow-lg <%= current_user.unread_support_messages_count > 0 ? '' : 'hidden' %>">
            <%= current_user.unread_support_messages_count %>
        </span>
        <% else %>
        <span id="chat-toggle-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center shadow-lg hidden"></span>
        <% end %>
    </button>

    <!-- Chat Box -->
    <div id="chat-box" class="hidden absolute bottom-16 right-0 w-80 h-96 bg-white rounded-lg shadow-xl border border-gray-200 flex flex-col transform transition-all duration-300">
        <!-- Chat Header -->
        <div class="bg-green-600 text-white px-4 py-3 rounded-t-lg flex justify-between items-center drag-handle cursor-move">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-300 rounded-full animate-pulse"></div>
                <span class="font-semibold">
                    <% if user_signed_in? && (current_user&.support? || current_user&.admin?) %>
                    Quick Chat
                    <% else %>
                    Support Chat
                    <% end %>
                </span>
                <!-- Single badge element in header -->
                <% if user_signed_in? && current_user.unread_support_messages_count > 0 %>
                <span id="chat-header-badge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full font-medium">
                    <%= current_user.unread_support_messages_count %> unread
                </span>
                <% else %>
                <span id="chat-header-badge" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full font-medium hidden"></span>
                <% end %>
            </div>
            <button id="chat-close" class="text-white hover:text-green-200 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Chat Messages Area -->
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-3">
            <!-- Welcome Message -->
            <% if user_signed_in? && (current_user&.support? || current_user&.admin?) %>
            <div class="flex">
                <div class="bg-blue-100 border border-blue-200 rounded-lg p-3 max-w-xs">
                    <p class="text-sm text-blue-800">ðŸ‘‹ Quick chat mode active</p>
                    <p class="text-xs text-blue-600 mt-1">Select a user from the dropdown below</p>
                    <% if user_signed_in? && current_user.unread_support_messages_count > 0 %>
                    <p id="user-unread-message" class="text-xs text-blue-800 mt-1 font-medium">
                        You have <%= current_user.unread_support_messages_count %> unread message<%= current_user.unread_support_messages_count == 1 ? '' : 's' %>
                    </p>
                    <% else %>
                    <p id="user-unread-message" class="text-xs text-blue-800 mt-1 font-medium hidden"></p>
                    <% end %>
                </div>
            </div>
            <% else %>
            <div class="flex">
                <div class="bg-green-100 border border-green-200 rounded-lg p-3 max-w-xs">
                    <p class="text-sm text-green-800">Hello! ðŸ‘‹ How can we help you today?</p>
                    <p class="text-xs text-green-600 mt-1">We typically reply within minutes</p>
                    <% if user_signed_in? && current_user.unread_support_messages_count > 0 %>
                    <p id="user-unread-message" class="text-xs text-green-800 mt-1 font-medium">
                        You have <%= current_user.unread_support_messages_count %> unread message<%= current_user.unread_support_messages_count == 1 ? '' : 's' %>
                    </p>
                    <% else %>
                    <p id="user-unread-message" class="text-xs text-green-800 mt-1 font-medium hidden"></p>
                    <% end %>
                </div>
            </div>
            <% end %>
        </div>

        <!-- Chat Input Area -->
        <div class="border-t border-gray-200 p-3 bg-white rounded-b-lg">
            <% if user_signed_in? && (current_user&.support? || current_user&.admin?) %>
            <!-- Support User Interface -->
            <%= form_with url: support_create_message_path, method: :post, id: "chat-form", class: "space-y-2", data: { remote: true } do |form| %>
            <div class="mb-2">
                <select name="user_id" id="support-user-select" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500">
                    <option value="">Select a user to chat with...</option>
                    <% if user_signed_in? %>
                    <% 
                    # Cache unread counts to avoid N+1 queries
                    # FIX: Count messages FROM users TO current support user (not the other way around)
                    unread_counts = {}
                    User.where.not(id: current_user.id).each do |user|
                      unread_counts[user.id] = SupportMessage.where(
                        sender_id: user.id,
                        sender_type: 'User',
                        receiver_id: current_user.id,
                        receiver_type: 'User',
                        read_at: nil
                      ).count
                    end
                    
                    # Sort users by unread count then name
                    users_sorted = User.where.not(id: current_user.id).sort_by do |user|
                      [-unread_counts[user.id], user.name.downcase]
                    end
                    %>
                    <% users_sorted.each do |user| %>
                    <% unread_count = unread_counts[user.id] || 0 %>
                    <option value="<%= user.id %>" data-unread-count="<%= unread_count %>">
                        <%= user.name %>
                        <% if unread_count > 0 %>
                        <span class="text-red-600 font-medium">
                            (<%= unread_count %> unread)
                        </span>
                        <% end %>
                    </option>
                    <% end %>
                    <% end %>
                </select>
            </div>
            <div class="flex space-x-2">
                <textarea name="message" id="chat-input" rows="1" placeholder="Type your message..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm" maxlength="500" disabled></textarea>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors self-end disabled:bg-gray-400" disabled id="send-button">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            <% end %>
            <% else %>
            <!-- Regular User Interface or Non-logged in User -->
            <%= form_with url: support_chat_messages_path, method: :post, id: "chat-form", class: "space-y-2" do |form| %>
            <% if user_signed_in? %>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-2">
                <p class="text-xs text-blue-800 text-center">
                    ðŸ’¬ Chatting as <strong><%= current_user.name %></strong>
                </p>
                <p id="user-unread-message" class="text-xs text-blue-800 text-center mt-1 font-medium <%= current_user.unread_support_messages_count > 0 ? '' : 'hidden' %>">
                    You have <%= current_user.unread_support_messages_count %> unread message<%= current_user.unread_support_messages_count == 1 ? '' : 's' %>
                </p>
            </div>
            <%= form.hidden_field :name, value: current_user.name %>
            <%= form.hidden_field :email, value: current_user.email %>
            <% else %>
            <div class="grid grid-cols-2 gap-2">
                <%= form.text_field :name, 
                    placeholder: "Your name",
                    class: "px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500" %>
                <%= form.email_field :email,
                    placeholder: "Your email", 
                    class: "px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500" %>
            </div>
            <% end %>

            <div class="flex space-x-2">
                <%= form.text_area :message, 
                    id: "chat-input",
                    rows: 1,
                    placeholder: "Type your message...",
                    class: "flex-1 px-3 py-2 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm",
                    maxlength: 500 %>
                <%= form.button type: "submit", 
                    class: "bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors self-end" do %>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                <% end %>
            </div>
            <% end %>
            <% end %>
            <p class="text-xs text-gray-500 mt-2 text-center">
                <% if user_signed_in? && (current_user&.support? || current_user&.admin?) %>
                Messages are sent directly to selected user
                <% else %>
                All messages are sent to our support team
                <% end %>
            </p>
        </div>
    </div>
</div>

<%= javascript_include_tag 'chat_widget' %>

<style>
    /* Additional styles for better dragging experience */
    #chat-widget {
        transition: transform 0.1s ease;
    }

    #chat-widget:active {
        transition: none;
    }

    .drag-handle {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    /* Ensure chat box stays positioned relative to widget when dragged */
    #chat-box {
        transform-origin: bottom right;
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
        #chat-box {
            width: 90vw;
            right: 5vw;
            bottom: 5rem;
        }
    }

    /* Animation for badge */
    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>
<!--------------------------------- End of Chat Widget ------------------->

<% else %>
<!-- Show disabled chat widget for unverified users -->
<div id="chat-widget" class="fixed bottom-6 right-6 z-50">
    <button onclick="window.location.href='<%= verification_path %>'" class="bg-gray-400 hover:bg-gray-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-300" title="Verify email to enable chat">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
            !
        </span>
    </button>
</div>
<% end %>
<% end %>